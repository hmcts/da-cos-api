#!groovy

@Library("Infrastructure")

import uk.gov.hmcts.contino.GradleBuilder
import uk.gov.hmcts.contino.AppPipelineConfig
import uk.gov.hmcts.contino.MetricsPublisher

def type = "java"
def product = "da"
def component = "cos-api"

GradleBuilder builder = new GradleBuilder(this, product)

def pipelineConf = new AppPipelineConfig()

withPipeline(type, product, component) {
  enableAksStagingDeployment()
  disableLegacyDeployment()
  syncBranchesWithMaster(['demo', 'perftest', 'ithc'])
  enableSlackNotifications('#da-tech-notifications')

  after('checkout') {
    echo 'da-cos-api checked out'
  }

  after('test') {
    steps.junit '**/test-results/**/*.xml'
    steps.archiveArtifacts allowEmptyArchive: true, artifacts: 'build/reports/**/*'
  }

  before('functionalTest:aat') {
    env.test_environment = 'aat'
  }

  after('functionalTest:aat') {
    steps.archiveArtifacts allowEmptyArchive: true, artifacts: '**/site/serenity/**/*'
    steps.archiveArtifacts allowEmptyArchive: true, artifacts: 'build/reports/**/*'
  }

  // Kubernetes does not retrieve variables from the output terraform
  before('functionalTest:preview') {
    env.test_environment = 'aat'
  }

  after('functionalTest:preview') {
    steps.archiveArtifacts allowEmptyArchive: true, artifacts: '**/site/serenity/**/*'
    steps.archiveArtifacts allowEmptyArchive: true, artifacts: 'build/reports/**/*'
  }
}
